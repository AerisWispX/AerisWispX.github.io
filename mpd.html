<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="robots" content="noindex, nofollow">
<meta name="referrer" content="no-referrer">
<title>HelloSports Player</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.7.11/shaka-player.compiled.js"></script>
<style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
  html, body {
    width: 100%; height: 100%;
    background: #000;
    overflow: hidden;
    font-family: sans-serif;
  }
  #video-container {
    position: relative;
    width: 100%;
    height: 100%;
  }
  video {
    width: 100%;
    height: 100%;
    object-fit: fill;
    display: block;
    background: #000;
  }
  .watermark-link {
    position: absolute;
    top: 10px;
    left: 10px;
    z-index: 9999;
    background: #D50000;
    color: white;
    padding: 6px 12px;
    font-size: 14px;
    font-weight: bold;
    border-radius: 4px;
    text-decoration: none;
    animation: pulse 2.5s infinite ease-in-out;
  }
  @keyframes pulse { 0%,100%{opacity:1;} 50%{opacity:0.6;} }
  .watermark-link:hover { background: #FF1744; }

  /* Controls overlay */
  .controls {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    background: linear-gradient(transparent, rgba(0,0,0,0.85));
    padding: 30px 16px 12px;
    display: flex;
    align-items: center;
    gap: 10px;
    opacity: 0;
    transition: opacity 0.3s;
    z-index: 100;
  }
  #video-container:hover .controls,
  #video-container.paused .controls { opacity: 1; }

  .ctrl-btn {
    background: none;
    border: none;
    color: #fff;
    cursor: pointer;
    padding: 4px;
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0.9;
    transition: opacity 0.2s, transform 0.15s;
    flex-shrink: 0;
  }
  .ctrl-btn:hover { opacity: 1; transform: scale(1.12); }
  .ctrl-btn svg { width: 22px; height: 22px; fill: white; }

  .time-display {
    color: #fff;
    font-size: 13px;
    white-space: nowrap;
    opacity: 0.85;
    flex-shrink: 0;
  }

  .volume-slider {
    width: 70px;
    accent-color: #D50000;
    cursor: pointer;
    flex-shrink: 0;
  }

  .spacer { flex: 1; }

  /* Quality selector */
  .quality-select {
    background: rgba(0,0,0,0.6);
    border: 1px solid rgba(255,255,255,0.3);
    color: #fff;
    font-size: 12px;
    padding: 3px 6px;
    border-radius: 4px;
    cursor: pointer;
    outline: none;
    flex-shrink: 0;
  }
  .quality-select option { background: #1a1a1a; }

  /* Loading spinner */
  .spinner {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 48px; height: 48px;
    border: 4px solid rgba(255,255,255,0.15);
    border-top-color: #D50000;
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
    z-index: 50;
    display: none;
  }
  .spinner.visible { display: block; }
  @keyframes spin { to { transform: translate(-50%, -50%) rotate(360deg); } }

  /* Error message */
  .error-msg {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    color: #fff;
    background: rgba(200,0,0,0.75);
    padding: 18px 28px;
    border-radius: 8px;
    font-size: 15px;
    text-align: center;
    display: none;
    z-index: 200;
    max-width: 80%;
  }
  .error-msg.visible { display: block; }

  /* Big play button */
  .big-play {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%) scale(1);
    width: 64px; height: 64px;
    background: rgba(213,0,0,0.85);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    z-index: 60;
    transition: transform 0.2s, opacity 0.2s;
    opacity: 0;
    pointer-events: none;
  }
  .big-play.visible { opacity: 1; pointer-events: all; }
  .big-play:hover { transform: translate(-50%, -50%) scale(1.1); }
  .big-play svg { width: 28px; height: 28px; fill: white; margin-left: 4px; }
</style>
</head>
<body oncontextmenu="return false;">

<div id="video-container">
  <a href="https://www.hellosports.live" target="_blank" class="watermark-link">HelloSports.live</a>

  <video id="video" playsinline autoplay></video>

  <div class="spinner" id="spinner"></div>
  <div class="error-msg" id="error-msg"></div>

  <div class="big-play" id="big-play">
    <svg viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
  </div>

  <div class="controls" id="controls">
    <!-- Play/Pause -->
    <button class="ctrl-btn" id="play-btn" title="Play/Pause">
      <svg id="play-icon" viewBox="0 0 24 24"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>
    </button>

    <!-- Volume -->
    <button class="ctrl-btn" id="mute-btn" title="Mute/Unmute">
      <svg id="vol-icon" viewBox="0 0 24 24"><path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/></svg>
    </button>
    <input type="range" class="volume-slider" id="vol-slider" min="0" max="1" step="0.05" value="1">

    <!-- Time -->
    <span class="time-display" id="time-display">LIVE</span>

    <div class="spacer"></div>

    <!-- Quality -->
    <select class="quality-select" id="quality-select" title="Quality">
      <option value="-1">Auto</option>
    </select>

    <!-- Fullscreen -->
    <button class="ctrl-btn" id="fs-btn" title="Fullscreen">
      <svg viewBox="0 0 24 24"><path d="M7 14H5v5h5v-2H7v-3zm-2-4h2V7h3V5H5v5zm12 7h-3v2h5v-5h-2v3zM14 5v2h3v3h2V5h-5z"/></svg>
    </button>
  </div>
</div>

<script>
// --- Helpers ---
function getParam(name) {
  return new URLSearchParams(window.location.search).get(name) || "";
}

function decodeUrl() {
  const get = getParam("get");
  const file = getParam("file");
  if (get) {
    try { return atob(get); } catch(e) { return get; }
  }
  return file;
}

const fileUrl = decodeUrl();
const video = document.getElementById("video");
const container = document.getElementById("video-container");
const spinner = document.getElementById("spinner");
const errorMsg = document.getElementById("error-msg");
const bigPlay = document.getElementById("big-play");
const playBtn = document.getElementById("play-btn");
const playIcon = document.getElementById("play-icon");
const muteBtn = document.getElementById("mute-btn");
const volIcon = document.getElementById("vol-icon");
const volSlider = document.getElementById("vol-slider");
const timeDisplay = document.getElementById("time-display");
const qualitySelect = document.getElementById("quality-select");

const PLAY_SVG = `<path d="M8 5v14l11-7z"/>`;
const PAUSE_SVG = `<path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/>`;
const VOL_ON_SVG = `<path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/>`;
const VOL_OFF_SVG = `<path d="M16.5 12c0-1.77-1.02-3.29-2.5-4.03v2.21l2.45 2.45c.03-.2.05-.41.05-.63zm2.5 0c0 .94-.2 1.82-.54 2.64l1.51 1.51C20.63 14.91 21 13.5 21 12c0-4.28-2.99-7.86-7-8.77v2.06c2.89.86 5 3.54 5 6.71zM4.27 3L3 4.27 7.73 9H3v6h4l5 5v-6.73l4.25 4.25c-.67.52-1.42.93-2.25 1.18v2.06c1.38-.31 2.63-.95 3.69-1.81L19.73 21 21 19.73l-9-9L4.27 3zM12 4L9.91 6.09 12 8.18V4z"/>`;

function setPlayIcon(playing) {
  playIcon.innerHTML = playing ? PAUSE_SVG : PLAY_SVG;
}

function setVolIcon(muted) {
  volIcon.innerHTML = muted ? VOL_OFF_SVG : VOL_ON_SVG;
}

function showError(msg) {
  spinner.classList.remove("visible");
  errorMsg.textContent = msg;
  errorMsg.classList.add("visible");
}

// --- No URL ---
if (!fileUrl) {
  document.getElementById("video-container").innerHTML =
    `<h2 style="color:white;text-align:center;margin-top:20%">No stream URL provided</h2>`;
} else {
  initPlayer();
}

async function initPlayer() {
  shaka.polyfill.installAll();

  if (!shaka.Player.isBrowserSupported()) {
    showError("Browser not supported for DASH playback.");
    return;
  }

  spinner.classList.add("visible");

  const player = new shaka.Player(video);

  // Configure for low latency and robustness
  player.configure({
    streaming: {
      lowLatencyMode: false,
      inaccurateManifestTolerance: 10,
      rebufferingGoal: 2,
      bufferingGoal: 30,
      bufferBehind: 30,
      retryParameters: {
        maxAttempts: 4,
        baseDelay: 1000,
        backoffFactor: 2,
        fuzzFactor: 0.5,
        timeout: 30000,
      },
    },
    manifest: {
      retryParameters: {
        maxAttempts: 3,
        baseDelay: 1000,
        backoffFactor: 2,
        fuzzFactor: 0.5,
        timeout: 15000,
      },
      dash: {
        ignoreMinBufferTime: true,
      }
    },
    abr: {
      enabled: true,
      defaultBandwidthEstimate: 1e6,
    },
  });

  // Error handling
  player.addEventListener("error", (e) => {
    console.error("Shaka error:", e.detail);
    const code = e.detail ? e.detail.code : "?";
    const msg = e.detail ? e.detail.message : "Unknown error";
    showError(`Playback error (${code}): ${msg}`);
  });

  // Buffering state
  player.addEventListener("buffering", (e) => {
    spinner.classList.toggle("visible", e.buffering);
  });

  // Load stream
  try {
    await player.load(fileUrl);
    spinner.classList.remove("visible");
    populateQualities(player);
    video.play().catch(() => {
      bigPlay.classList.add("visible");
    });
  } catch (err) {
    console.error("Load error:", err);
    showError(`Failed to load stream: ${err.message || err}`);
  }

  // Quality selector
  function populateQualities(p) {
    const tracks = p.getVariantTracks();
    qualitySelect.innerHTML = `<option value="-1">Auto</option>`;
    const seen = new Set();
    tracks
      .filter(t => t.type === "variant")
      .sort((a, b) => b.height - a.height)
      .forEach(t => {
        const label = t.height ? `${t.height}p` : `${Math.round((t.bandwidth||0)/1000)}k`;
        if (!seen.has(label)) {
          seen.add(label);
          const opt = document.createElement("option");
          opt.value = t.id;
          opt.textContent = label;
          qualitySelect.appendChild(opt);
        }
      });
  }

  qualitySelect.addEventListener("change", () => {
    const val = parseInt(qualitySelect.value);
    if (val === -1) {
      player.configure({ abr: { enabled: true } });
    } else {
      player.configure({ abr: { enabled: false } });
      const tracks = player.getVariantTracks();
      const track = tracks.find(t => t.id === val);
      if (track) player.selectVariantTrack(track, true);
    }
  });

  // Play/Pause
  function togglePlay() {
    if (video.paused) { video.play(); }
    else { video.pause(); }
  }

  video.addEventListener("play", () => {
    setPlayIcon(true);
    container.classList.remove("paused");
    bigPlay.classList.remove("visible");
  });
  video.addEventListener("pause", () => {
    setPlayIcon(false);
    container.classList.add("paused");
    bigPlay.classList.add("visible");
  });
  video.addEventListener("ended", () => { setPlayIcon(false); });

  playBtn.addEventListener("click", togglePlay);
  bigPlay.addEventListener("click", () => { video.play(); });
  video.addEventListener("click", togglePlay);

  // Volume
  muteBtn.addEventListener("click", () => {
    video.muted = !video.muted;
    setVolIcon(video.muted);
    volSlider.value = video.muted ? 0 : video.volume;
  });
  volSlider.addEventListener("input", () => {
    video.volume = parseFloat(volSlider.value);
    video.muted = video.volume === 0;
    setVolIcon(video.muted);
  });

  // Time display
  video.addEventListener("timeupdate", () => {
    if (!isFinite(video.duration) || video.duration === Infinity) {
      timeDisplay.textContent = "LIVE";
    } else {
      const fmt = (s) => String(Math.floor(s)).padStart(2,"0");
      const t = video.currentTime;
      const d = video.duration;
      timeDisplay.textContent =
        `${fmt(t/60)}:${fmt(t%60)} / ${fmt(d/60)}:${fmt(d%60)}`;
    }
  });

  // Fullscreen
  document.getElementById("fs-btn").addEventListener("click", () => {
    if (!document.fullscreenElement) {
      container.requestFullscreen?.() || container.webkitRequestFullscreen?.();
    } else {
      document.exitFullscreen?.() || document.webkitExitFullscreen?.();
    }
  });
}
</script>
</body>
</html>
